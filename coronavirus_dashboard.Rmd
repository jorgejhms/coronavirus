---
title: "Coronavirus en el Perú"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    source_code: "https://github.com/jorgejhms/coronavirus"
    social: ["menu"]
---

```{r setup, include=FALSE}

Sys.setlocale(category = "LC_ALL", locale ="es_ES.UTF-8") # setea el sistema en español

library(flexdashboard)
library(ggplot2) # graficos
library(dplyr) # manipulación de data
library(zoo) # series de tiempo
library(readr)
library(tidyr)
library(RcppRoll)
library("viridis") # paleta de colores
library(lubridate) # manejo de fechas
library(DT)
library(broom)
library(sf)

source("funciones.R") #carga funciones de R

## --- Carga de datos --- ##

owiddata <- read.csv("data/owid-covid-data.csv")
minsa_p <- read.csv("data/positivos_covid.csv", sep = ";")
minsa_f <- read.csv("data/fallecidos_covid.csv", sep = ";")
sinadef <- read.csv("data/fallecidos_sinadef.csv", sep = ";", fileEncoding = "latin1", skip = 2) #cambio a read.csv para aplicar separador

mapa <- read_sf(dsn = "data/dept/.", layer = "DEPARTAMENTOS")

owid_per <- owiddata %>%
  filter(iso_code == "PER")

## Limpieza de Data
## ----------------

minsa_p <- minsa_p %>%
  mutate(
    FECHA_RESULTADO = as.Date(as.character(FECHA_RESULTADO), format = "%Y%m%d"),
    EDAD_n = as.numeric(EDAD),
    DEPARTAMENTO = recode(DEPARTAMENTO, "LIMA REGION" = "LIMA") #Juntando Lima y Lima pronvincias
  ) %>%
  filter(!is.na(FECHA_RESULTADO))

minsa_f <- minsa_f %>%
  mutate(
    FECHA_CORTE = as.Date(as.character(FECHA_CORTE), format = "%Y%m%d"),
    FECHA_FALLECIMIENTO = as.Date(as.character(FECHA_FALLECIMIENTO), format = "%Y%m%d"),
    FECHA_NAC = as.Date(as.character(FECHA_NAC), format = "%Y%m%d"),
  )

sinadef <- sinadef %>%
  mutate(FECHA = as.Date(FECHA),
         año = year(FECHA)) %>%
  filter(
    !is.na(FECHA),
    `DEPARTAMENTO.DOMICILIO` != "EXTRANJERO",
    `MUERTE.VIOLENTA` %in% c("SIN REGISTRO", "NO SE CONOCE")
  )

mapa <- mapa %>% rename(DEPARTAMENTO = DEPARTAMEN)

## --- Generando acumulados --- ##

minsa_db <- minsa_p %>%
  select(FECHA_RESULTADO) %>%
  group_by(FECHA_RESULTADO) %>%
  summarise(positivos = n()) %>%
  mutate(positivos_cum = cumsum(replace_na(positivos, 0))) %>%
  rename(fecha = FECHA_RESULTADO)

fallecidos_cum <-
  minsa_f %>%
  select(FECHA_FALLECIMIENTO) %>%
  group_by(FECHA_FALLECIMIENTO) %>%
  summarise(fallecidos = n()) %>%
  mutate(fallecidos_cum = cumsum(replace_na(fallecidos, 0))) %>%
  rename(fecha = FECHA_FALLECIMIENTO)

minsa_db <- full_join(minsa_db, fallecidos_cum, by = "fecha" ) %>%
  arrange(fecha)
rm(fallecidos_cum)

## Data adicional:
## ---------------
censo_2017 <- tribble (
  ~Departamento,~Poblacion,
  "Amazonas",379384,
  "Ancash",1083519,
  "Apurímac",405759,
  "Arequipa",1382730,
  "Ayacucho",616176,
  "Cajamarca",1341012,
  "Callao",994494,
  "Cusco",1205527,
  "Huancavelica",347639,
  "Huánuco",721047,
  "Ica",850765,
  "Junín",1246038,
  "La Libertad",1778080,
  "Lambayeque",1197260,
  "Lima",9485405,
  "Loreto",883510,
  "Madre de Dios",141070,
  "Moquegua",174863,
  "Pasco",254065,
  "Piura",1856809,
  "Puno",1172697,
  "San Martín",813381,
  "Tacna",329332,
  "Tumbes",224863,
  "Ucayali",496459,
)


departamentos <-
  c (
    "AMAZONAS",
    "ANCASH",
    "APURIMAC",
    "AREQUIPA",
    "AYACUCHO",
    "CAJAMARCA",
    "CALLAO",
    "CUSCO",
    "HUANCAVELICA",
    "HUÁNUCO",
    "ICA",
    "JUNÍN",
    "LA LIBERTAD",
    "LAMBAYEQUE",
    "LIMA",
    "LORETO",
    "MADRE DE DIOS",
    "MOQUEGUA",
    "PASCO",
    "PIURA",
    "PUNO",
    "SAN MARTÍN",
    "TACNA",
    "TUMBES",
    "UCAYALI"
  )

### Funciones

g_diario <- function(k, n) {
   ggplot(k, aes(x = fecha, y = n)) +
      geom_bar(stat = "identity", color = "red", alpha = 0.5) +
      geom_line(aes(y = rollmean(n, 7, fill = NA)), color = "red4", size = 2) +
      scale_x_date(date_labels = "%b",
                   breaks = "1 month",
                   minor_breaks = NULL) +
      theme (legend.position = "bottom"
             , legend.title = element_blank()) +
      labs(x = element_blank(),
           y = element_blank(),
           title = element_blank())
}
 


```

Inicio
========

Cabecera
--------

### Presentación

Dashboard con la última información de los datos abiertos del MINSA. Este dahsboard ha sido creado con el objetivo de servir como herramienta de aprendizaje en el procesamiento y visualización de información. La información presentada debe ser tomada como referencial.

### Última actualización
```{r}
fecha_actualizacion <- minsa_p %>%
  pull(FECHA_RESULTADO) %>%
  max()

valueBox(fecha_actualizacion)
```

Contagios 
---------

### Personas contagiadas
```{r}
minsa_p %>%
  summarise(count = n()) %>%
  pull() %>%
  prettyNum(big.mark = ",") %>%
  valueBox(icon = "fa-user", color = "warning")
```

### Personas fallecidas
```{r}
minsa_f %>%
  summarise(count = n()) %>%
  pull() %>%
  prettyNum(big.mark = ",") %>%
  valueBox(icon = "fa-cross", color = "danger")
```

### Nuevos contagios en el último día
```{r}
contagios_dia <- last(minsa_db$positivos_cum)
valueBox(contagios_dia, color = "warning")
```

### Fallecidos en el último día
```{r}
fallecidos_dia <- last (minsa_db$fallecidos_cum)
valueBox(fallecidos_dia, color = "danger")
```

Evolución de la pandemia {data-height = 500}
--------------------------------------------

### Evolución de positivos
```{r, fig.width=6, fig.height=4}
g_diario(minsa_db, minsa_db$positivos)
```


### Evolución de fallecidos en el MINSA
```{r, fig.width=6, fig.height=4}

g_diario(minsa_db, minsa_db$fallecidos)
```

Fila {data-height = 500}
-----------------------

### Fallecidos en SINADEF
```{r, fig.width=6, fig.height=4}
sinadef %>%
  filter(FECHA <= fecha_actualizacion) %>%
  group_by(FECHA) %>%
  summarise(count = n()) %>%
  mutate (año = substr(FECHA, 1, 4), #mantener extracción de datos para convertirlo en discreto
          date = as.Date(format(FECHA, "1990-%m-%d"))) %>% # mapea años en uno mismo
  ggplot(aes(x = date, y = count, colour = año)) +
  geom_line(size = 0.8) +
  scale_x_date(date_labels = "%b",
               breaks = "1 month",
               minor_breaks = "1 week") +
  scale_color_manual(values = c (rep("darkgray", 3), "orange", "red")) +
  labs (x = "Fecha", y = "Casos") +
  theme (legend.position = "bottom", legend.title = element_blank())
```


### Data por regiones

```{r}
positivos_sem <-
  minsa_p %>%
  filter(FECHA_RESULTADO >= fecha_actualizacion - days(14)) %>%
  select(DEPARTAMENTO) %>%
  group_by(DEPARTAMENTO) %>%
  summarise(count = n()) %>%
  mutate(tasa = round(count / censo_2017$Poblacion * 100000, 0)) %>%
  select(-count)

tabla_regiones <-
  minsa_p %>%
  select(DEPARTAMENTO) %>%
  group_by(DEPARTAMENTO) %>%
  summarise(count = n()) %>%
  mutate(positivos_pct = round(prop.table(count) * 100, 2)) %>%
  rename(Contagios = count)

fallecidos_regiones <-
  minsa_f %>%
  select(DEPARTAMENTO) %>%
  group_by(DEPARTAMENTO) %>%
  summarise(count = n()) %>%
  mutate(fallecidos_pct = round(prop.table(count) * 100, 2)) %>%
  rename(Fallecidos = count)

tabla_regiones <-
  full_join(tabla_regiones, fallecidos_regiones, by = "DEPARTAMENTO")
tabla_regiones <-
  full_join(tabla_regiones, positivos_sem, by = "DEPARTAMENTO")

datatable(
  tabla_regiones,
  class = 'cell-border stripe',
  colnames = c(
    'Departamento',
    'Contagios',
    '%',
    'Fallecidos',
    '%',
    "Contagios x 100 mil hab. ultimos 14 días"
  ),
  options = list(pageLength = 13)
)
```

Créditos
--------

Fuente: [Datos abiertos del MINSA](https://www.minsa.gob.pe/datosabiertos/).

Mapa de riesgo 
==============

Explicación {.sidebar} 
-----------------------

El siguiente mapa muestra el riesgo actual de contagios por coronavirus para cada departamento del país. El mismo se ha creado inspirado en un [semaforo similar creado para la Unión Europea](https://www.dw.com/en/coronavirus-what-the-eus-new-traffic-light-system-means/a-55265476).

Los colores representan los diferentes niveles de riesgo:

* **Nivel Bajo (Verde):** Hasta 25 contagios por cada 100 mil habitantes en los últimos 14 días.
* **Nivel Medio (Amarillo):** Entre 25 y 150 contagios por cada 100 mil habitantes en los últimos 14 días.
* **Nivel Alto (Rojo):** Más de 150 contagios por cada 100 mil habitantes en los ultimos 14 días.

**ATENCIÓN**

**LA INFORMACIÓN PRESENTADA ES PARTE DE UN EJERCICIO PERSONAL EN EL ANÁLISIS Y VISUALIZACIÓN DE INFORMACIÓN ESTADÍSTICA. NO SE PUEDE TOMAR COMO RECOMENDACIÓN MÉDICA O INFORMACIÓN OFICIAL.**


Mapa de riesgo 
--------------

### Mapa de riesgo 
```{r, fig.width=12, fig.height=8}

tabla_mapa <-
  tabla_regiones %>%
  select(DEPARTAMENTO, tasa)

tabla_mapa <-
  full_join(mapa, tabla_mapa, by = "DEPARTAMENTO")

ggplot(tabla_mapa, aes (fill = cut(tasa, c(-Inf, 25, 150, Inf)))) +
  geom_sf() +
  scale_fill_manual(
    name = "Riesgo",
    values = c(
      "(-Inf,25]" = "green",
      "(25,150]" = "yellow",
      "(150, Inf]" = "red"
    ),
    labels = c (
      "(-Inf,25]" = "Bajo",
      "(25,150]" = "Medio",
      "(150, Inf]" = "Alto"
    )
  ) +
  coord_sf()
```

Tendencia
=========

```{r, fig.width=12, fig.height=8}
minsa_p %>%
  select(FECHA_RESULTADO) %>%
  group_by(FECHA_RESULTADO) %>%
  summarise(count = n()) %>%
  mutate(
    sum_sem = roll_sum (count, 7, fill = NA, align = "right"),
    #Suma los casos de la semana previa, requiere RcppRoll
    positivos_cum = cumsum(replace_na(count, 0))
  ) %>%
  ggplot(aes(x = positivos_cum, y = sum_sem)) +
  geom_line() +
  scale_x_log10(limits = c(50, NA)) +
  scale_y_log10(limits = c(40, NA)) +
  labs (x = "Número de casos", y = "Casos de la semana anterior", title = "Tendencia de Coronavirus")
```