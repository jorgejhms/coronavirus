---
title: "Coronavirus en el Perú"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    source_code: "https://github.com/jorgejhms/coronavirus"
    social: ["menu"]
---

```{r setup, include=FALSE}

Sys.setlocale(category = "LC_ALL", locale ="es_ES.UTF-8") # setea el sistema en espalol

library(flexdashboard)
library(ggplot2) # graficos
library(dplyr) # manipulación de data
library(zoo) # series de tiempo
library(readr)
library(tidyr)
library(RcppRoll)
library("viridis") # paleta de colores
library(lubridate) # manejo de fechas
library(DT)
library(broom)
library(sf)

source("funciones.R") #carga funciones de R

positivos <- read.csv("data/positivos_covid.csv", sep = ";")
fallecidos <- read.csv("data/fallecidos_covid.csv", sep = ";")
fallecidos_sinadef <-
  read.csv(
    "data/fallecidos_sinadef.csv",
    sep = ";",
    fileEncoding = "latin1",
    skip = 2
  ) #cambio a read.csv para aplicar separador
reportes_minsa <-
  read.csv("data/reportes_minsa.csv",
           sep = ";",
           fileEncoding = "UTF-8")
mapa <- read_sf(dsn = "data/dept/.", layer = "DEPARTAMENTOS")

## Limpieza de Data
## ----------------

positivos <- positivos %>%
  mutate(
    y = substr(FECHA_RESULTADO, 1, 4),
    m = substr(FECHA_RESULTADO, 5, 6),
    d = substr(FECHA_RESULTADO, 7, 8),
    fecha = as.Date(paste0(y, "-", m, "-", d)),
    EDAD_n = as.numeric(EDAD),
    DEPARTAMENTO = recode(DEPARTAMENTO, "LIMA REGION" = "LIMA") #Juntando Lima y Lima pronvincias
  ) %>%
  filter(!is.na(fecha))

fallecidos <- fallecidos %>%
  mutate(
    fallecidos,
    y = substr(FECHA_FALLECIMIENTO, 1, 4),
    m = substr(FECHA_FALLECIMIENTO, 5, 6),
    d = substr(FECHA_FALLECIMIENTO, 7, 8),
    fecha = as.Date(paste0(y, "-", m, "-", d)),
    edad_declarada = as.numeric(EDAD_DECLARADA),
    yn = substr(FECHA_NAC, 1, 4),
    mn = substr(FECHA_NAC, 5, 6),
    dn = substr(FECHA_NAC, 7, 8)
  ) %>%
  filter(!is.na(fecha))

fallecidos_sinadef <- fallecidos_sinadef %>%
  mutate(
    fecha = as.Date(fallecidos_sinadef$FECHA),
    año = substr(fecha, 1, 4)
  ) %>%
  filter(!is.na(fecha)) %>%
  filter(
    `DEPARTAMENTO.DOMICILIO` != "EXTRANJERO",
    `MUERTE.VIOLENTA` %in% c("SIN REGISTRO", "NO SE CONOCE")
  )

mapa <- mapa %>%
  rename(DEPARTAMENTO = DEPARTAMEN)

## Generando acumulados:
## ---------------------

positivos_cum <-
  positivos %>%
  select(fecha) %>%
  group_by(fecha) %>%
  summarise(count = n()) %>%
  mutate(positivos_cum = cumsum(replace_na(count, 0)))

fallecidos_cum <-
  fallecidos %>%
  select(fecha) %>%
  group_by(fecha) %>%
  summarise(count = n()) %>%
  mutate(fallecidos_cum = cumsum(replace_na(count, 0)))

## Data adicional:
## ---------------
censo_2017 <- tribble (
  ~Departamento,~Poblacion,
  "Amazonas",379384,
  "Ancash",1083519,
  "Apurímac",405759,
  "Arequipa",1382730,
  "Ayacucho",616176,
  "Cajamarca",1341012,
  "Callao",994494,
  "Cusco",1205527,
  "Huancavelica",347639,
  "Huánuco",721047,
  "Ica",850765,
  "Junín",1246038,
  "La Libertad",1778080,
  "Lambayeque",1197260,
  "Lima",9485405,
  "Loreto",883510,
  "Madre de Dios",141070,
  "Moquegua",174863,
  "Pasco",254065,
  "Piura",1856809,
  "Puno",1172697,
  "San Martín",813381,
  "Tacna",329332,
  "Tumbes",224863,
  "Ucayali",496459,
)


departamentos <-
  c (
    "AMAZONAS",
    "ANCASH",
    "APURIMAC",
    "AREQUIPA",
    "AYACUCHO",
    "CAJAMARCA",
    "CALLAO",
    "CUSCO",
    "HUANCAVELICA",
    "HUÁNUCO",
    "ICA",
    "JUNÍN",
    "LA LIBERTAD",
    "LAMBAYEQUE",
    "LIMA",
    "LORETO",
    "MADRE DE DIOS",
    "MOQUEGUA",
    "PASCO",
    "PIURA",
    "PUNO",
    "SAN MARTÍN",
    "TACNA",
    "TUMBES",
    "UCAYALI"
  )

```

Inicio
========

Cabecera
--------

### Presentación

Dashboard con la última información de los datos abiertos del MINSA. Este dahsboard ha sido creado con el objetivo de servir como herramienta de aprendizaje en el procesamiento y visualización de información. La información presentada debe ser tomada como referencial.

### Última actualización
```{r}
fecha_actualizacion <- positivos %>%
  pull(fecha) %>%
  max()

valueBox(fecha_actualizacion)
```

Contagios 
---------

### Personas contagiadas
```{r}
positivos %>%
  summarise(count = n()) %>%
  pull() %>%
  valueBox(icon = "fa-user", color = "warning")
```

### Personas fallecidas
```{r}
fallecidos %>%
  summarise(count = n()) %>%
  pull() %>%
  valueBox(icon = "fa-cross", color = "danger")
```

### Nuevos contagios en el último día
```{r}
contagios_dia <- last(positivos_cum$count)
valueBox(contagios_dia, color = "warning")
```

### Fallecidos en el último día
```{r}
fallecidos_dia <- last (fallecidos_cum$count)
valueBox(fallecidos_dia, color = "danger")
```

Evolución de la pandemia {data-height = 500}
--------------------------------------------

### Evolución de positivos
```{r, fig.width=6, fig.height=4}
positivos %>%
      select(fecha) %>%
      group_by(fecha) %>%
      summarise(count = n()) %>%
      ggplot(aes(x = fecha, y = count)) +
      geom_bar(stat = "identity") +
      geom_line(aes(y = rollmean(count, 7, fill = NA), color = "red"), size = 1.5) +
      scale_color_manual(values = "red", labels = "Media móvil 7 días") +
      scale_x_date(date_labels = "%b",
                   breaks = "1 month",
                   minor_breaks = "1 week") +
      labs (x = "Fecha", y = "Casos") +
      theme (legend.position = "bottom"
             , legend.title = element_blank()) +
      labs(x = element_blank(),
           y = element_blank(),
           title = element_blank())
```


### Evolución de fallecidos en el MINSA
```{r, fig.width=6, fig.height=4}

fallecidos %>%
      select(fecha) %>%
      group_by(fecha) %>%
      summarise(count = n()) %>%
      ggplot(aes(x = fecha, y = count)) +
      geom_bar(stat = "identity") +
      geom_line(aes(y = rollmean(count, 7, fill = NA), color = "red"), size = 1.5) +
      scale_color_manual(values = "red", labels = "Media móvil 7 días") +
      scale_x_date(date_labels = "%b",
                   breaks = "1 month",
                   minor_breaks = "1 week") +
      labs (x = "Fecha", y = "Casos") +
      theme (legend.position = "bottom"
             , legend.title = element_blank()) +
      labs(x = element_blank(),
           y = element_blank(),
           title = element_blank())
```

Fila {data-height = 500}
-----------------------

### Fallecidos en SINADEF
```{r, fig.width=6, fig.height=4}
fallecidos_sinadef %>%
  filter(fecha <= fecha_actualizacion) %>%
  group_by(fecha) %>%
  summarise(count = n()) %>%
  mutate(
    año = substr(fecha, 1, 4),
    mes = substr(fecha, 6, 7),
    date = as.Date(format(fecha, "1990-%m-%d")),
  ) %>%
  ggplot(aes(x = date, y = count, colour = año)) +
  geom_line(size = 0.8) +
  scale_x_date(date_labels = "%b",
               breaks = "1 month",
               minor_breaks = "1 week") +
  scale_color_manual(values = c (rep("darkgray", 3), "orange", "red")) +
  labs (x = "Fecha", y = "Casos") +
  theme (legend.position = "bottom", legend.title = element_blank())
```


### Data por regiones

```{r}
positivos_sem <-
  positivos %>%
  filter(fecha >= fecha_actualizacion - days(14)) %>%
  select(DEPARTAMENTO) %>%
  group_by(DEPARTAMENTO) %>%
  summarise(count = n()) %>%
  mutate(tasa = round(count / censo_2017$Poblacion * 100000, 0)) %>%
  select(-count)

tabla_regiones <-
  positivos %>%
  select(DEPARTAMENTO) %>%
  group_by(DEPARTAMENTO) %>%
  summarise(count = n()) %>%
  mutate(positivos_pct = round(prop.table(count) * 100, 2)) %>%
  rename(Contagios = count)

fallecidos_regiones <-
  fallecidos %>%
  select(DEPARTAMENTO) %>%
  group_by(DEPARTAMENTO) %>%
  summarise(count = n()) %>%
  mutate(fallecidos_pct = round(prop.table(count) * 100, 2)) %>%
  rename(Fallecidos = count)

tabla_regiones <-
  full_join(tabla_regiones, fallecidos_regiones, by = "DEPARTAMENTO")
tabla_regiones <-
  full_join(tabla_regiones, positivos_sem, by = "DEPARTAMENTO")

datatable(
  tabla_regiones,
  class = 'cell-border stripe',
  colnames = c(
    'Departamento',
    'Contagios',
    '%',
    'Fallecidos',
    '%',
    "Contagios x 100 mil hab. ultimos 14 días"
  ),
  options = list(pageLength = 13)
)
```

Créditos
--------

Fuente: [Datos abiertos del MINSA](https://www.minsa.gob.pe/datosabiertos/).

Mapa de riesgo 
==============

Explicación {.sidebar} 
-----------------------

El siguiente mapa muestra el riesgo actual de contagios por coronavirus para cada departamento del país. El mismo se ha creado inspirado en un [semaforo similar creado para la Unión Europea](https://www.dw.com/en/coronavirus-what-the-eus-new-traffic-light-system-means/a-55265476).

Los colores representan los diferentes niveles de riesgo:

* **Nivel Bajo (Verde):** Hasta 25 contagios por cada 100 mil habitantes en los últimos 14 días.
* **Nivel Medio (Amarillo):** Entre 25 y 150 contagios por cada 100 mil habitantes en los últimos 14 días.
* **Nivel Alto (Rojo):** Más de 150 contagios por cada 100 mil habitantes en los ultimos 14 días.

**ATENCIÓN**

**LA INFORMACIÓN PRESENTADA ES PARTE DE UN EJERCICIO PERSONAL EN EL ANÁLISIS Y VISUALIZACIÓN DE INFORMACIÓN ESTADÍSTICA. NO SE PUEDE TOMAR COMO RECOMENDACIÓN MÉDICA O INFORMACIÓN OFICIAL.**


Mapa de riesgo 
--------------

### Mapa de riesgo 
```{r, fig.width=12, fig.height=8}

tabla_mapa <-
  tabla_regiones %>%
  select(DEPARTAMENTO, tasa)

tabla_mapa <-
  full_join(mapa, tabla_mapa, by = "DEPARTAMENTO")

ggplot(tabla_mapa, aes (fill = cut(tasa, c(-Inf, 25, 150, Inf)))) +
  geom_sf() +
  scale_fill_manual(
    name = "Riesgo",
    values = c(
      "(-Inf,25]" = "green",
      "(25,150]" = "yellow",
      "(150, Inf]" = "red"
    ),
    labels = c (
      "(-Inf,25]" = "Bajo",
      "(25,150]" = "Medio",
      "(150, Inf]" = "Alto"
    )
  ) +
  coord_sf()
```

Tendencia
=========

```{r, fig.width=12, fig.height=8}
positivos %>%
  select(fecha) %>%
  group_by(fecha) %>%
  summarise(count = n()) %>%
  mutate(
    sum_sem = roll_sum (count, 7, fill = NA, align = "right"),
    #Suma los casos de la semana previa, requiere RcppRoll
    positivos_cum = cumsum(replace_na(count, 0))
  ) %>%
  ggplot(aes(x = positivos_cum, y = sum_sem)) +
  geom_line() +
  scale_x_log10(limits = c(50, NA)) +
  scale_y_log10(limits = c(40, NA)) +
  labs (x = "Número de casos", y = "Casos de la semana anterior", title = "Tendencia de Coronavirus")
```